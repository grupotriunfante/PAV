<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Acompanhamento de Vendedor</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3f51b5;
            --accent-color: #4CAF50;
            --secondary-bg-color: #f0f4f8;
            --text-color: #333;
            --light-gray: #e0e0e0;
            --dark-gray: #555;
            --border-radius: 8px;
            --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --box-shadow-medium: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 960px;
            margin: 30px auto;
            background: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-medium);
            position: relative;
            overflow: hidden;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
            font-weight: 700;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 12px;
            margin-top: 40px;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 500;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        .info-field {
            margin-bottom: 25px;
            padding: 15px 20px;
            background-color: #e8f0fe;
            border-left: 6px solid #6272d3;
            border-radius: var(--border-radius);
        }

        .info-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-gray);
            font-size: 1.1em;
        }

        .info-field input[type="text"],
        .info-field input[type="date"],
        .info-field select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .info-field input[readonly] {
            background-color: #f5f5f5;
            cursor: default;
        }

        .audit-item {
            background: var(--secondary-bg-color);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: var(--box-shadow-light);
        }

        .audit-item .question-text {
            flex-grow: 1;
            margin-right: 25px;
            font-size: 1.05em;
        }

        .question-number {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .radio-options {
            display: flex;
            gap: 25px;
            margin-left: auto;
        }

        .radio-options label {
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .required-media-field {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background-color: #fefefe;
            border: 1px dashed var(--light-gray);
            border-radius: var(--border-radius);
        }

        .required-media-field label {
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }

        .required-media-field input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            background-color: #fff;
            cursor: pointer;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .preview-item {
            position: relative;
            width: 110px;
            height: 110px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .file-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 5px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .remove-btn:hover {
            background-color: rgba(255, 0, 0, 0.8);
        }

        .submit-button {
            display: block;
            width: 100%;
            padding: 18px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            margin-top: 40px;
        }

        .hidden-field {
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="inicio.htm" class="back-button">Voltar</a>
        <h1>Plano de Acompanhamento de Vendedor</h1>

        <div class="info-field">
            <label for="supervisorName">Supervisor Comercial:</label>
            <input type="text" id="supervisorName" name="supervisorName" placeholder="Nome do Supervisor" required readonly>
        </div>
        <div class="info-field">
            <label for="salespersonName">Nome do Vendedor:</label>
            <select id="salespersonName" name="salespersonName" required>
                <option value="">Selecione o Vendedor</option>
            </select>
        </div>
        <div class="info-field">
            <label for="clientCnpj">CNPJ do Cliente:</label>
            <input type="text" id="clientCnpj" name="clientCnpj" placeholder="00.000.000/0000-00" required maxlength="18">
        </div>
        <div class="info-field">
            <label for="clientName">Nome do Cliente:</label>
            <input type="text" id="clientName" name="clientName" placeholder="Nome do Cliente">
        </div>
        <div class="info-field">
            <label for="visitDate">Data da Visita:</label>
            <input type="date" id="visitDate" name="visitDate" required>
        </div>

        <form id="auditForm">
            <section>
                <h2>1. Planejamento do Dia</h2>
                <ul>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.1.</span> Está bem-apresentado (higiene pessoal, vestimenta adequada, crachá)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_1" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_1" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.2.</span> Palm carregado e funcionando?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_2" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_2" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.3.</span> Carro limpo, organizado e com materiais de execução?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_3" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_3" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.4.</span> Roteiro de visitas definido (primeiro e último cliente)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_4" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_4" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.5.</span> Metas do dia definidas (faturamento, mix, eficácia)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_5" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_5" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.6.</span> Materiais em mãos (catálogos, materiais de PDV, kit execução, agenda)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_6" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_6" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.7.</span> Conhecimento das campanhas e ações vigentes?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_7" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_7" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.8.</span> Pendências revisadas (pedidos, retornos)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_8" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_8" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">1.9.</span> Pontualidade nas visitas?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="planejamento_1_9" value="sim" required> Sim</label>
                            <label><input type="radio" name="planejamento_1_9" value="nao"> Não</label>
                        </div>
                    </li>
                </ul>
            </section>
            <section>
                <h2>2. Pré Visita</h2>
                <ul>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">2.1.</span> Verificou histórico de compras e financeiro?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="preVisit_2_1" value="sim" required> Sim</label>
                            <label><input type="radio" name="preVisit_2_1" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">2.2.</span> Criou estratégias considerando o tamanho, localização e público do cliente?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="preVisit_2_2" value="sim" required> Sim</label>
                            <label><input type="radio" name="preVisit_2_2" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">2.3.</span> Itens focos do mês e mix de produtos?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="preVisit_2_3" value="sim" required> Sim</label>
                            <label><input type="radio" name="preVisit_2_3" value="nao"> Não</label>
                        </div>
                    </li>
                </ul>
            </section>
            <section>
                <h2>3. Leitura de Loja</h2>
                <ul>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">3.1.</span> Analisou todos os corredores da loja para analisar exposição dos nossos produtos?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="storeReading_3_1" value="sim" data-target-field="storeReading_3_1_img_container"> Sim</label>
                            <label><input type="radio" name="storeReading_3_1" value="nao" data-target-field="storeReading_3_1_img_container"> Não</label>
                        </div>
                        <div class="required-media-field hidden-field" id="storeReading_3_1_img_container">
                            <label for="storeReading_3_1_img">Anexar imagens (Máx. 10). Clique para adicionar mais fotos.</label>
                            <input type="file" id="storeReading_3_1_img" name="storeReading_3_1_img" accept="image/*" multiple>
                            <div class="image-preview" id="storeReading_3_1_img_preview"></div>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">3.2.</span> Todos os produtos estão na área de vendas precificados e acessíveis?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="storeReading_3_2" value="sim" data-target-field="storeReading_3_2_img_container"> Sim</label>
                            <label><input type="radio" name="storeReading_3_2" value="nao" data-target-field="storeReading_3_2_img_container"> Não</label>
                        </div>
                        <div class="required-media-field hidden-field" id="storeReading_3_2_img_container">
                            <label for="storeReading_3_2_img">Anexar imagens (Máx. 5). Clique para adicionar mais fotos.</label>
                            <input type="file" id="storeReading_3_2_img" name="storeReading_3_2_img" accept="image/*" multiple>
                            <div class="image-preview" id="storeReading_3_2_img_preview"></div>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">3.3.</span> Visitou o estoque do cliente?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="storeReading_3_3" value="sim" required> Sim</label>
                            <label><input type="radio" name="storeReading_3_3" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">3.4.</span> Verificou rupturas e sugeriu novos produtos?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="storeReading_3_4" value="sim" required> Sim</label>
                            <label><input type="radio" name="storeReading_3_4" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">3.5.</span> Checou lançamentos e mix prioritário para o segmento?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="storeReading_3_5" value="sim" required> Sim</label>
                            <label><input type="radio" name="storeReading_3_5" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">3.6.</span> Montou um pré-pedido com base na leitura?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="storeReading_3_6" value="sim" required> Sim</label>
                            <label><input type="radio" name="storeReading_3_6" value="nao"> Não</label>
                        </div>
                    </li>
                </ul>
            </section>
            <section>
                <h2>4. Execução</h2>
                <ul>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">4.1.</span> Abasteceu a loja com produtos do estoque?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="execution_4_1" value="sim" data-target-field="execution_4_1_img_container"> Sim</label>
                            <label><input type="radio" name="execution_4_1" value="nao" data-target-field="execution_4_1_img_container"> Não</label>
                        </div>
                        <div class="required-media-field hidden-field" id="execution_4_1_img_container">
                            <label for="execution_4_1_img">Anexar imagens (Máx. 5). Clique para adicionar mais fotos.</label>
                            <input type="file" id="execution_4_1_img" name="execution_4_1_img" accept="image/*" multiple>
                            <div class="image-preview" id="execution_4_1_img_preview"></div>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">4.2.</span> Garantiu limpeza e organização dos produtos nos expositores?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="execution_4_2" value="sim" data-target-field="execution_4_2_img_container"> Sim</label>
                            <label><input type="radio" name="execution_4_2" value="nao" data-target-field="execution_4_2_img_container"> Não</label>
                        </div>
                        <div class="required-media-field hidden-field" id="execution_4_2_img_container">
                            <label for="execution_4_2_img">Anexar imagens (Máx. 5). Clique para adicionar mais fotos.</label>
                            <input type="file" id="execution_4_2_img" name="execution_4_2_img" accept="image/*" multiple>
                            <div class="image-preview" id="execution_4_2_img_preview"></div>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">4.3.</span> Posicionou expositores em locais estratégicos?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="execution_4_3" value="sim" data-target-field="execution_4_3_img_container"> Sim</label>
                            <label><input type="radio" name="execution_4_3" value="nao" data-target-field="execution_4_3_img_container"> Não</label>
                        </div>
                        <div class="required-media-field hidden-field" id="execution_4_3_img_container">
                            <label for="execution_4_3_img">Anexar imagens (Máx. 5). Clique para adicionar mais fotos.</label>
                            <input type="file" id="execution_4_3_img" name="execution_4_3_img" accept="image/*" multiple>
                            <div class="image-preview" id="execution_4_3_img_preview"></div>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">4.4.</span> Aplicou Cross Merchandising?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="execution_4_4" value="sim" data-target-field="execution_4_4_img_container"> Sim</label>
                            <label><input type="radio" name="execution_4_4" value="nao" data-target-field="execution_4_4_img_container"> Não</label>
                        </div>
                        <div class="required-media-field hidden-field" id="execution_4_4_img_container">
                            <label for="execution_4_4_img">Anexar imagens (Máx. 5). Clique para adicionar mais fotos.</label>
                            <input type="file" id="execution_4_4_img" name="execution_4_4_img" accept="image/*" multiple>
                            <div class="image-preview" id="execution_4_4_img_preview"></div>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">4.5.</span> Verificou validade dos produtos (FIFO)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="execution_4_5" value="sim" required> Sim</label>
                            <label><input type="radio" name="execution_4_5" value="nao"> Não</label>
                        </div>
                    </li>
                </ul>
            </section>
            <section>
                <h2>5. Negociação</h2>
                <ul>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">5.1.</span> Iniciou negociação destacando os serviços prestados?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="negotiation_5_1" value="sim" required> Sim</label>
                            <label><input type="radio" name="negotiation_5_1" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">5.2.</span> Mostrou soluções aplicadas (preço, validade, organização, materiais de merchandising utilizados)?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="negotiation_5_2" value="sim" required> Sim</label>
                            <label><input type="radio" name="negotiation_5_2" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">5.3.</span> Apresentou levantamento de estoque?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="negotiation_5_3" value="sim" required> Sim</label>
                            <label><input type="radio" name="negotiation_5_3" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">5.4.</span> Reforçou parceria com o cliente?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="negotiation_5_4" value="sim" required> Sim</label>
                            <label><input type="radio" name="negotiation_5_4" value="nao"> Não</label>
                        </div>
                    </li>
                </ul>
            </section>
            <section>
                <h2>6. Fechamento da Visita</h2>
                <ul>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">6.1.</span> Combinou valor do pedido, prazo e entrega?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="closing_6_1" value="sim" required> Sim</label>
                            <label><input type="radio" name="closing_6_1" value="nao"> Não</label>
                        </div>
                    </li>
                    <li class="audit-item">
                        <span class="question-text"><span class="question-number">6.2.</span> Repassou retorno da próxima visita para gerar expectativa para a próxima negociação?</span>
                        <div class="radio-options">
                            <label><input type="radio" name="closing_6_2" value="sim" required> Sim</label>
                            <label><input type="radio" name="closing_6_2" value="nao"> Não</label>
                        </div>
                    </li>
                </ul>
            </section>
            <button type="submit" class="submit-button">Finalizar Acompanhamento</button>
        </form>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        const uploadedFiles = {};
        const GOOGLE_APP_SCRIPT_URL_POST = 'https://script.google.com/macros/s/AKfycbw-DXVXSxS_Q2YjcPxC1jBtvrpe4w8TbWRt33Zxy85hKHcIEyF52kpN14bial4OoH-p/exec';

        document.addEventListener('DOMContentLoaded', () => {

            // ===== INÍCIO DA ALTERAÇÃO: SCRIPT PARA FORMATAR CNPJ =====
            const cnpjInput = document.getElementById('clientCnpj');
            if (cnpjInput) {
                cnpjInput.addEventListener('input', function(e) {
                    // 1. Remove tudo que não for dígito
                    let value = e.target.value.replace(/\D/g, '');

                    // 2. Limita o valor a 14 dígitos
                    if (value.length > 14) {
                        value = value.substring(0, 14);
                    }

                    // 3. Aplica a máscara XX.XXX.XXX/XXXX-XX
                    if (value.length > 12) {
                        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                    } else if (value.length > 8) {
                        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{1,4})/, '$1.$2.$3/$4');
                    } else if (value.length > 5) {
                        value = value.replace(/^(\d{2})(\d{3})(\d{1,3})/, '$1.$2.$3');
                    } else if (value.length > 2) {
                        value = value.replace(/^(\d{2})(\d{1,3})/, '$1.$2');
                    }

                    // 4. Atualiza o valor do campo
                    e.target.value = value;
                });
            }
            // ===== FIM DA ALTERAÇÃO =====

            // --- Lógica do Supervisor e Vendedor ---
            const supervisorNameInput = document.getElementById('supervisorName');
            const salespersonSelect = document.getElementById('salespersonName');
            const loggedInUsername = localStorage.getItem('username');

            if (loggedInUsername) {
                supervisorNameInput.value = loggedInUsername;
            }

            const GOOGLE_APP_SCRIPT_URL_GET = 'https://script.google.com/macros/s/AKfycbw-DXVXSxS_Q2YjcPxC1jBtvrpe4w8TbWRt33Zxy85hKHcIEyF52kpN14bial4OoH-p/exec';

            async function fetchSalespersons() {
                let url = `${GOOGLE_APP_SCRIPT_URL_GET}?action=getSalespersons`;
                if (loggedInUsername) {
                    url += `&supervisorName=${encodeURIComponent(loggedInUsername)}`;
                }
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.success) {
                        populateSalespersonDropdown(data.salespersons);
                    } else {
                        console.error('Failed to fetch salespeople:', data.message);
                    }
                } catch (error) {
                    console.error('Error fetching salespeople:', error);
                }
            }

            function populateSalespersonDropdown(salespersons) {
                salespersonSelect.innerHTML = '<option value="">Selecione o Vendedor</option>';
                salespersons.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.name;
                    option.textContent = person.name;
                    option.dataset.supervisor = person.supervisor;
                    salespersonSelect.appendChild(option);
                });
            }

            salespersonSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.supervisor) {
                    supervisorNameInput.value = selectedOption.dataset.supervisor;
                } else {
                    supervisorNameInput.value = loggedInUsername || '';
                }
            });

            fetchSalespersons();

            // --- Lógica para mostrar/ocultar campos ---
            const radioButtons = document.querySelectorAll('input[type="radio"][data-target-field]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const targetFieldId = event.target.dataset.targetField;
                    const targetFieldContainer = document.getElementById(targetFieldId);
                    if (targetFieldContainer) {
                        const fileInput = targetFieldContainer.querySelector('input[type="file"]');
                        if (event.target.value === 'sim') {
                            targetFieldContainer.classList.remove('hidden-field');
                        } else {
                            targetFieldContainer.classList.add('hidden-field');
                            if (fileInput) {
                                fileInput.value = '';
                                uploadedFiles[fileInput.id] = [];
                                document.getElementById(`${fileInput.id}_preview`).innerHTML = '';
                            }
                        }
                    }
                });
            });

            // --- Lógica para adicionar e gerenciar múltiplos arquivos ---
            const fileInputs = document.querySelectorAll('#auditForm input[type="file"]');
            const imageLimits = {
                'storeReading_3_1_img': 10,
                'storeReading_3_2_img': 5,
                'execution_4_1_img': 5,
                'execution_4_2_img': 5,
                'execution_4_3_img': 5,
                'execution_4_4_img': 5
            };

            fileInputs.forEach(input => {
                uploadedFiles[input.id] = [];
                input.addEventListener('change', (event) => {
                    const currentFiles = uploadedFiles[input.id];
                    const newFiles = Array.from(event.target.files);
                    const limit = imageLimits[input.id] || 1;

                    if (currentFiles.length + newFiles.length > limit) {
                        alert(`Você pode selecionar no máximo ${limit} fotos. Você já tem ${currentFiles.length} e tentou adicionar ${newFiles.length}.`);
                        event.target.value = '';
                        return;
                    }
                    currentFiles.push(...newFiles);
                    renderPreview(input.id);
                    event.target.value = '';
                });
            });

            const renderPreview = (inputId) => {
                const previewContainer = document.getElementById(`${inputId}_preview`);
                previewContainer.innerHTML = '';

                uploadedFiles[inputId].forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.classList.add('preview-item');
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        const fileNameSpan = document.createElement('span');
                        fileNameSpan.classList.add('file-name');
                        fileNameSpan.textContent = file.name;
                        const removeBtn = document.createElement('button');
                        removeBtn.classList.add('remove-btn');
                        removeBtn.textContent = 'X';
                        removeBtn.type = 'button';
                        removeBtn.onclick = () => {
                            uploadedFiles[inputId].splice(index, 1);
                            renderPreview(inputId);
                        };
                        previewItem.appendChild(img);
                        previewItem.appendChild(fileNameSpan);
                        previewItem.appendChild(removeBtn);
                        previewContainer.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            };

            // --- Lógica de Envio do Formulário ---
            const form = document.getElementById('auditForm');
            const questionWeights = {
                'planejamento_1_1': 1,
                'planejamento_1_2': 1,
                'planejamento_1_3': 1,
                'planejamento_1_4': 1,
                'planejamento_1_5': 1,
                'planejamento_1_6': 1,
                'planejamento_1_7': 1,
                'planejamento_1_8': 1,
                'planejamento_1_9': 1,
                'preVisit_2_1': 1,
                'preVisit_2_2': 1,
                'preVisit_2_3': 1,
                'storeReading_3_1': 1,
                'storeReading_3_2': 1,
                'storeReading_3_3': 1,
                'storeReading_3_4': 1,
                'storeReading_3_5': 1,
                'storeReading_3_6': 1,
                'execution_4_1': 1,
                'execution_4_2': 1,
                'execution_4_3': 1,
                'execution_4_4': 1,
                'execution_4_5': 1,
                'negotiation_5_1': 1,
                'negotiation_5_2': 1,
                'negotiation_5_3': 1,
                'negotiation_5_4': 1,
                'closing_6_1': 1,
                'closing_6_2': 1
            };

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.classList.add('visible');

                const auditData = {
                    supervisorName: supervisorNameInput.value,
                    salespersonName: salespersonSelect.value,
                    // ===== INÍCIO DA ALTERAÇÃO: Envia apenas os números do CNPJ =====
                    clientCnpj: document.getElementById('clientCnpj').value.replace(/\D/g, ''),
                    // ===== FIM DA ALTERAÇÃO =====
                    clientName: document.getElementById('clientName').value,
                    visitDate: document.getElementById('visitDate').value,
                    submissionTimestamp: new Date().toISOString()
                };

                let totalScore = 0;
                for (const questionName in questionWeights) {
                    const selectedOption = document.querySelector(`input[name="${questionName}"]:checked`);
                    if (selectedOption) {
                        auditData[questionName] = selectedOption.value;
                        if (selectedOption.value === 'sim') totalScore += questionWeights[questionName];
                    } else {
                        alert(`Por favor, responda a todas as perguntas. Pergunta ausente: ${questionName}`);
                        loadingOverlay.classList.remove('visible');
                        return;
                    }
                }
                auditData.totalScore = totalScore;

                // Validação manual de imagens obrigatórias
                for (const inputId in imageLimits) {
                    const radioGroupName = inputId.replace('_img', '');
                    const simRadio = document.querySelector(`input[name="${radioGroupName}"][value="sim"]`);
                    if (simRadio && simRadio.checked) {
                        if (!uploadedFiles[inputId] || uploadedFiles[inputId].length === 0) {
                            const label = document.querySelector(`label[for="${inputId}"]`);
                            const labelText = label ? label.textContent.split('(')[0].trim() : `campo ${inputId}`;
                            alert(`É obrigatório anexar ao menos uma imagem para o campo: "${labelText}"`);
                            loadingOverlay.classList.remove('visible');
                            return;
                        }
                    }
                }

                auditData.images = {};
                for (const inputId in uploadedFiles) {
                    const files = uploadedFiles[inputId];
                    if (files.length > 0) {
                        auditData.images[inputId] = [];
                        for (const file of files) {
                            const base64 = await toBase64(file);
                            auditData.images[inputId].push(base64);
                        }
                    }
                }

                try {
                    await fetch(GOOGLE_APP_SCRIPT_URL_POST, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'submitAudit',
                            data: auditData
                        })
                    });
                    alert('Auditoria enviada com sucesso!');
                    form.reset();
                    document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                    document.querySelectorAll('.required-media-field').forEach(field => field.classList.add('hidden-field'));
                    for (const inputId in uploadedFiles) {
                        uploadedFiles[inputId] = [];
                        document.getElementById(`${inputId}_preview`).innerHTML = '';
                    }
                    supervisorNameInput.value = loggedInUsername || ''; // Restaura o nome do supervisor logado
                } catch (error) {
                    console.error('Erro ao enviar auditoria:', error);
                    alert('Ocorreu um erro ao enviar a auditoria.');
                } finally {
                    loadingOverlay.classList.remove('visible');
                }
            });

            const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        });
    </script>
</body>

</html>
